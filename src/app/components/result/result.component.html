<app-header *ngIf="displayForm">
  <app-domain-check></app-domain-check>
</app-header>
<app-header *ngIf="!displayForm">
  <h1>Result</h1>
</app-header>
<div class="result container">
  <div>
    <div class="result-header">
      <h2>{{form.domain}}</h2>
      <i>{{ test.creation_time | date:'yyyy-MM-dd HH:mm zzzz' }}</i>
    </div>
    <div class="actions-btn">
      <div>
        <a class="btn btn-secondary history" (click)="getHistory()">
          <i class="fa fa-history text-white" aria-hidden="true"></i>
          <span class="text-white">{{'History'|translate}}</span>
        </a>

        <div ngbDropdown placement="bottom-center" class="d-inline-block">
          <button class="btn btn-secondary export" id="shareDropdownResult" ngbDropdownToggle>
            <i class="fa fa-cloud-download text-white"></i>
            <span class="text-white">{{'Export'|translate}}</span>
          </button>
          <div ngbDropdownMenu aria-labelledby="shareDropdownResult">
              <div class="dropdown-body">
                <button class="btn" (click)="exportJson()"> JSON </button>
                <button class="btn" (click)="exportCSV()"> CSV </button>
                <button class="btn" (click)="exportHTML()"> HTML </button>
                <button class="btn" (click)="exportText()"> TEXT </button>
              </div>
          </div>
        </div>

        <div ngbDropdown placement="bottom-right" class="d-inline-block">
          <button class="btn btn-secondary share" id="shareDropdownResult" ngbDropdownToggle>
            <i class="fa fa-share text-white"></i>
            <span class="text-white">{{'Share'|translate}}</span>
          </button>
          <div ngbDropdownMenu aria-labelledby="shareDropdownResult">
              <div class="dropdown-body">
                <input readonly="" type="text" id="link_location" name="link_location" class="form-inline" value="{{test.location}}">
                <button class="btn btn-clipboard" (click)="copyLinkToClipboard(test.location)">
                    <i class="fa fa-clipboard"></i>
                </button>
              </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="filters">
    <ul class="nav nav-pills vertical-align filter">
      <li class="nav-item ml-1">
        <ng-template #tooltipAll>{{ 'TOOLTIP_ALL' | translate }}</ng-template>
        <a placement="top" [ngbTooltip]="tooltipAll"
           class="nav-link" [ngClass]="{'active all text-white': resultFilter.all}"
           (click)="togglePillFilter('all')"
           [(ngModel)]="resultFilter.all" ngDefaultControl>
          All <span class="badge badge-pill badge-secondary">{{testCasesCount['all']}}</span></a>
      </li>
      <li class="nav-item ml-1">
        <ng-template #tooltipInfo>{{ 'TOOLTIP_INFO' | translate }}</ng-template>
        <a placement="top" [ngbTooltip]="tooltipInfo"
           class="nav-link" [ngClass]="{'active info text-white': resultFilter.info}"
           (click)="togglePillFilter('info')"
           [(ngModel)]="resultFilter.info" ngDefaultControl>
          Info
          <span class="badge badge-pill badge-secondary">{{testCasesCount['info']}}</span></a>
      </li>
      <li class="nav-item ml-1">
        <ng-template #tooltipNotice>{{ 'TOOLTIP_NOTICE' | translate }}</ng-template>
        <a placement="top" [ngbTooltip]="tooltipNotice"
           class="nav-link" [ngClass]="{'active notice text-white': resultFilter.notice}"
           (click)="togglePillFilter('notice')"
           [(ngModel)]="resultFilter.notice" ngDefaultControl>
          Notice <span class="badge badge-pill badge-secondary">{{testCasesCount['notice']}}</span></a>
      </li>
      <li class="nav-item ml-1">
        <ng-template #tooltipWarning>{{ 'TOOLTIP_WARNING' | translate }}</ng-template>
        <a placement="top" [ngbTooltip]="tooltipWarning"
           class="nav-link" [ngClass]="{'active warning text-white': resultFilter.warning}"
           (click)="togglePillFilter('warning')"
           [(ngModel)]="resultFilter.warning" ngDefaultControl>
          Warning <span class="badge badge-pill badge-secondary">{{testCasesCount['warning']}}</span></a>
      </li>
      <li class="nav-item ml-1">
        <ng-template #tooltipError>{{ 'TOOLTIP_ERROR' | translate }}</ng-template>
        <a placement="top" [ngbTooltip]="tooltipError"
           class="nav-link" [ngClass]="{'active error text-white': resultFilter.error}"
           (click)="togglePillFilter('error')"
           [(ngModel)]="resultFilter.error" ngDefaultControl>
          Error <span class="badge badge-pill badge-secondary">{{testCasesCount['error']}}</span></a>
      </li>
      <li class="nav-item ml-1">
        <ng-template #tooltipCritical>{{ 'TOOLTIP_CRITICAL' | translate }}</ng-template>
        <a placement="top" [ngbTooltip]="tooltipCritical"
           class="nav-link" [ngClass]="{'active critical text-white': resultFilter.critical}"
           (click)="togglePillFilter('critical')"
           [(ngModel)]="resultFilter.critical" ngDefaultControl>
          Critical <span class="badge badge-pill badge-secondary">{{testCasesCount['critical']}}</span></a>
      </li>
    </ul>
    <div class="input-group search">
      <input type="text" [(ngModel)]="resultFilter.search" (ngModelChange)='filterResults()' class="form-control" placeholder="{{'Filter text' | translate }}" aria-label="filter input" aria-describedby="basic-addon2">
      <div class="input-group-append">
        <span class="input-group-text">
          <i class="fa fa-filter" aria-hidden="true"></i>
        </span>
      </div>
    </div>
  </div>

  <div class="mt-3">
    <article *ngFor="let module of modules | keyvalue">
      <h3>{{module.key}}</h3>
      <article *ngFor="let testcase of module.value | keyvalue">
        <header>
          <div
            (click)="isCollapsed[testcase.key] = !isCollapsed[testcase.key]"
            [attr.aria-controls]="'testcase-' + testcase.key"
            [attr.aria-expanded]="!isCollapsed[testcase.key]"
          >
            <i class="fa" aria-hidden="true" [ngClass]="{'fa-plus-square-o': isCollapsed[testcase.key],'fa-minus-square-o': !isCollapsed[testcase.key]}"></i>

            <h4 class="{{testcase.value.level}}">
              <i class="fa {{severity_icons[testcase.value.level]}}" aria-hidden="true"></i>{{'testcases.' + testcase.key | translate}}
            </h4>
          </div>
          <a href="https://zonemaster-docs.rd.nic.fr/specifications/{{module.key|lowercase}}-tp/{{testcase.key|lowercase}}.html"><i class="fa fa-info-circle" aria-hidden="true"></i> {{testcase.key|lowercase}}</a>

        </header>
        <ul [class.collapsed]="isCollapsed[testcase.key]" id="testcase-{{testcase.key}}" >
          <li *ngFor="let entry of testcase.value.entries"><span class="{{entry.level|lowercase}}">{{entry.level}}</span> {{entry.message}} </li>
        </ul>
      </article>
    </article>
  </div>

<ng-template #historyModal let-c="close" let-d="dismiss">
  <div class="modal-header">
  <h4 class="modal-title">{{'History'|translate}}</h4>
    <button type="button" class="close" aria-label="Close" (click)="d('Cross click')">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <app-history [history]="history"></app-history>
  </div>
</ng-template>
